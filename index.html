<!DOCTYPE html>
<html lang="zh-yue">
<head>
	<meta charset="utf-8">
	<title>CantoRocks</title>

	<link rel="stylesheet" type="text/css" href="assets/shared.css"/>
	<link rel="stylesheet" type="text/css" href="assets/examples.css"/>
	<script src="assets/examples.js"></script>
</head>

<body onload="init();" style="background-color:#000000; width:800px; height:800px; padding:0px; margin:0px;">

<div id="content">
	<canvas id="gameCanvas" width="800" height="480" style="background:black;"></canvas>
	<input id="dummytextbox" type="text" style="display:none;"/>
</div>
<script src="libs/preloadjs-NEXT.min.js"></script>
<script src="libs/soundjs-NEXT.min.js"></script>
<script src="libs/tweenjs-NEXT.min.js"></script>
<script src="libs/easeljs-NEXT.min.js"></script>

<!-- We also provide hosted minified versions of all CreateJS libraries.
  http://code.createjs.com -->

<!-- Game variables -->
<script type="text/javascript">
  document.getElementById("dummytextbox").focus();
  var manifest;           // used to register sounds for preloading
  var rockimages;         // rock images for preloading
  
  var preload;

  var rockBelt;     //space rock array
  var currRock;     // points to the falling rock

  var canvas;     //Main canvas
  var stage;      //Main display stage
  var moribund;   // Pending death
  var alive;      //wheter the player is alive

  var gamePanel;      //a panel that contains every game object
  var qPanel;         //a panel that holds currRock question
  
  var messageField;   //Message display field
  var scoreField;     //score Field
  var qEnglishField;
  var qTextField;
  var typingField;    //user input
  var debugField;

  var loadingInterval = 0;
  
  var freeze_counter = 0;
  var MAX_FREEZE = 10;
  
  var score = 0;
</script>

<!-- Game script below -->
<script type="text/javascript" src="rock.js"></script>
<script type="text/javascript" src="question.js"></script>
<script type="text/javascript" src="audiospritelist.js"></script>

<script id="gameplay">

	//register key functions
	document.onkeydown = handleKeyDown;
	document.onkeyup = handleKeyUp;

	function init() {
		if (!createjs.Sound.initializeDefaultPlugins()) {
			document.getElementById("error").style.display = "block";
			document.getElementById("content").style.display = "none";
			return;
		}
/*
		if (createjs.BrowserDetect.isIOS || createjs.BrowserDetect.isAndroid || createjs.BrowserDetect.isBlackberry) {
			document.getElementById("mobile").style.display = "block";
			document.getElementById("content").style.display = "none";
			return;
		}
		*/

		canvas = document.getElementById("gameCanvas");
		stage = new createjs.Stage(canvas);
		messageField = new createjs.Text("Loading", "bold 24px Arial", "#FFFFFF");
		messageField.maxWidth = 1000;
		messageField.textAlign = "center";
		messageField.textBaseline = "middle";
		messageField.x = canvas.width / 2;
		messageField.y = canvas.height / 2;
		
    debugField = new createjs.Text("", "bold 20px Arial", "#FF0000");
    debugField.maxWidth = 240;
    debugField.textAlign = "left";
    debugField.textBaseline = "middle";
    debugField.x = 10;
    debugField.y = 100;

		stage.update(); 	//update the stage to show text

		// begin loading content (only sounds to load)
		var assetsPath = "sounds/";
		manifest = [
			{id: "begin", src: "spawn.ogg"},
			{id: "break", src: "break.ogg", data: 6},
			{id: "death", src: "death.ogg"},
			{id: "laser", src: "shot.ogg", data: 6},
			{id: "music", src: "music.ogg"}
		];

    var assetsPath2 = "images/";
    rockimages = [
      {id: "rock1", src: "brownrock.png"},
      {id: "rock2", src: "greyrock.png"}
    ];    

    createjs.Sound.alternateExtensions = ["mp3"];
    createjs.Sound.registerSounds(words);
    createjs.Sound.on("fileload", doneLoading);
    
		preload = new createjs.LoadQueue(true, assetsPath);
		preload.installPlugin(createjs.Sound);
		//preload.addEventListener("complete", doneLoading); // add an event listener for when load is completed
		//preload.addEventListener("progress", updateLoading);
		preload.loadManifest(manifest);
		
    preload2 = new createjs.LoadQueue(true, assetsPath2);
    preload2.loadManifest(rockimages);
    		
	}

	function stop() {
		if (preload != null) {
			preload.close();
		}
		createjs.Sound.stop();
	}

	function updateLoading() {
		messageField.text = "Loading " + (preload.progress * 100 | 0) + "%";
		stage.update();
	}

	function doneLoading(event) {
		clearInterval(loadingInterval);
		scoreField = new createjs.Text("0", "bold 50px Dosis", "#FFFFFF");
		scoreField.textAlign = "right";
		scoreField.x = 220;
		scoreField.y = 80;
		scoreField.maxWidth = 300;

		messageField.text = "Welcome: Click to play";

		// start the music
		//createjs.Sound.play("music", {interrupt: createjs.Sound.INTERRUPT_NONE, loop: -1, volume: 0.05});

		watchRestart();
	}

	function watchRestart() {
		//watch for clicks
		stage.addChild(messageField);
    stage.addChild(debugField);		
		stage.update(); 	//update the stage to show text
		canvas.onclick = handleClick;
	}

	function handleClick() {
		//prevent extra clicks and hide text
		canvas.onclick = null;
		stage.removeChild(messageField);

		// indicate the player is now on screen
		createjs.Sound.play("begin");

		restart();
	}

	//reset all game logic
	function restart() {
		//hide anything on stage and show the score
		stage.removeAllChildren();

    var lp = new createjs.Bitmap("images/leftpanel.png");
    lp.x = 0;
    lp.y = 0;
    lp.scaleX = 260 / 64;
    lp.scaleY = 480 / 64;
		
    var bg = new createjs.Bitmap("images/background.png");
    bg.x = 260;
    bg.y = 0;
    bg.scaleX = 0.7;
    bg.scaleY = 1;
  
    stage.addChild(lp);
    stage.addChild(bg);		
		
		gamePanel = new createjs.Container();
		gamePanel.x = 260;
		gamePanel.y = 0;
		gamePanel.width = canvas.width - 260;
		gamePanel.height = canvas.height;
		stage.addChild(gamePanel);   
		
    rockBelt = [];
		
		scoreField.text = (0).toString();

    qTextField = new createjs.Text("", "bold 60px Helvetica", "#483C32");
    qTextField.maxWidth = 1000;
    qTextField.textAlign = "center";
    qTextField.textBaseline = "middle";
    qTextField.x = 100;
    qTextField.y = 150;        

    qEnglishField = new createjs.Text("", "bold 20px Helvetica", "#832A0D");
    qEnglishField.maxWidth = 1000;
    qEnglishField.textAlign = "center";
    qEnglishField.textBaseline = "middle";
    qEnglishField.x = 100;
    qEnglishField.y = 200;        

    qPanel = new createjs.Container();
    qPanel.x = 30;
    qPanel.y = 150;
    qPanel.width = 200;
    qPanel.height = 250;
    
    stage.addChild(qPanel);
    qPanel.addChild(qEnglishField);
    qPanel.addChild(qTextField);

    
    var g = new createjs.Graphics();
    g.setStrokeStyle(3);
    g.beginStroke("#000000");
    g.beginFill("white");
    g.drawRoundRect (40,380,180,40,8);
    typingBox = new createjs.Shape(g);
    stage.addChild(typingBox);

    typingField = new createjs.Text("", "bold 25px Courier", "#000000");
    typingField.maxWidth = 1000;
    typingField.textAlign = "left";
    typingField.textBaseline = "middle";
    typingField.x = 60;
    typingField.y = 400;    
    
    stage.addChild(typingField);		
		stage.addChild(scoreField);
    stage.addChild(debugField);		

		//create the player
		alive = true;
		moribund = false;

		//ensure stage is blank and add the ship
		stage.clear();

		//start game timer
		if (!createjs.Ticker.hasEventListener("tick")) {
			createjs.Ticker.addEventListener("tick", tick);
		}
	}

	function tick(event) {
	  
    if (alive && !moribund) {
      
      //Scenario 0: Rock removed
      if (freeze_counter > 0) {
        currRock.alpha = freeze_counter / MAX_FREEZE;
        freeze_counter--;
        if (freeze_counter == 0){
          gamePanel.removeChild(currRock);
          addScore(currRock.question.text.length);
          createjs.Sound.play("break", createjs.Sound.INTERRUPT_ANY);
        } else {
          stage.update(event);  // update other sub events
          return;          
        }
      }
      
      //Scenario 1: bottom reached
      if (currRock) {
        if (currRock.y + currRock.getBounds().height > canvas.height) {
          currRock.freeze(preload2.getResult("rock2"));
        }
      }

      //Scenario 2: check if it has reached other rocks
      if (currRock) {
        for (spaceRock in rockBelt) {
          var r = rockBelt[spaceRock];
          if (!r.launched) continue;
          if (r == currRock) continue;
          var x_dif = Math.abs(currRock.x - r.x);
          var y_dif = Math.abs(currRock.y - r.y);
          if (Math.sqrt ( (x_dif * 84 / 101) * (x_dif * 84/101) + y_dif * y_dif ) < 84) {
            currRock.freeze(preload2.getResult("rock2")); //freeze the rock

            // check whether the user has lost the game
            if (currRock.y < 0) {
              moribund = true;
            }
            break;    
          }
        }
      }  
  
      if (!currRock || !currRock.active && alive && !moribund) {
        typingField.text = "";
        currRock = new Rock();
        currRock.init(preload2.getResult("rock1"), new Question(Math.floor(Math.random()*MAX_Q)));
        rockBelt.push(currRock);
        gamePanel.addChild(currRock);
        qEnglishField.text = currRock.question.english;
        qTextField.text = currRock.question.text;
        var inst = createjs.Sound.play(currRock.question.id, createjs.Sound.INTERRUPT_ANY);
      }
      
      if (currRock.active && alive && !moribund) {
        currRock.tick(event);     
      }

      //Officially ending the game        
      if (moribund) {  // Only run once
        alive = false;
        moribund = false; // You are real dead now.
        messageField.text = "You're dead:  Click or hit enter to play again";
        stage.addChild(messageField);
        watchRestart();
  
        //play death sound
        createjs.Sound.play("death", createjs.Sound.INTERRUPT_ANY);
      }
  
      //call sub ticks
      stage.update(event);
      
    }
	}

	//allow for WASD and arrow control scheme
	function handleKeyDown(e) {
		//cross browser issues exist
		if (!e) {
			var e = window.event;
		}
		var x = e.keyCode;
		switch (x) {
		  case 8:
		    typingField.text = typingField.text.substr(0,typingField.text.length-1);
		    return false;
			case 13:
			  typingField.text = "";
				if (canvas.onclick == handleClick) {
					handleClick();
				}
				return false;
		}
		if (!e.altKey && !e.metaKey){
  		  if (x == 32 || x >= 65 && x <= 90){
  		  typingField.text = typingField.text + String.fromCharCode(x).toLowerCase();
  		  
  		  if (currRock) {
  		    if (currRock.check(typingField.text)) {  		      
  		      var index = rockBelt.indexOf(currRock);
  		      rockBelt.splice(index,1);
  		      currRock.active = false;
            freeze_counter = MAX_FREEZE;
  		    }  
  		  }
  		  return false;
  		}
		}
	}

	function handleKeyUp(e) {
		//cross browser issues exist
		if (!e) {
			var e = window.event;
		}
		switch (e.keyCode) {
		}
		return false;
	}

	function addScore(value) {
		//trust the field will have a number and add the score
		score += Number(value);
		scoreField.text = score.toString();
	}
</script>

</body>
</html>
