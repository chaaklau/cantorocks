<!DOCTYPE html>
<html lang="zh-yue">
<head>
	<meta charset="utf-8">
	<title>CantoRocks</title>

	<link rel="stylesheet" type="text/css" href="assets/shared.css"/>
	<link rel="stylesheet" type="text/css" href="assets/examples.css"/>
	<style>
	  @font-face {
      font-family: Pixel;
      src: url(assets/PressStart2P.ttf);
    }
	</style>
	<script src="assets/examples.js"></script>

  <!-- CreateJS related minified files -->
  <script src="libs/preloadjs-NEXT.min.js"></script>
  <script src="libs/soundjs-NEXT.min.js"></script>
  <script src="libs/tweenjs-NEXT.min.js"></script>
  <script src="libs/easeljs-NEXT.min.js"></script>

	
  <!-- Game script below -->
  <script type="text/javascript" src="gameconfig.js"></script>
  <script type="text/javascript" src="rock.js"></script>
  <script type="text/javascript" src="question.js"></script>
  <script type="text/javascript" src="gamestate.js"></script>
  <script type="text/javascript" src="audiospritelist.js"></script>	
</head>

<body onload="init();" style="background-color:#000000; width:800px; height:500px; padding:0px; margin:0px;">

<div id="content">
  <input id="dummytextbox" type="text" style="height:1px; background:transparent; border:0px; width:800px;"/>  
	<canvas id="gameCanvas" width="800" height="480" style="background:black;"></canvas>
</div>

<!-- Game variables -->
<script type="text/javascript">
  document.getElementById("dummytextbox").focus();
  var manifest;           // used to register sounds for preloading
  var rockimages;         // rock images for preloading
  
  var preload;

  var rockBelt;     //space rock array
  var currRock;     // points to the falling rock

  var canvas;     //Main canvas
  var stage;      //Main display stage
  
  var pendingStart = false;
  
  var gamePanel;      //a panel that contains every game object
  var qPanel;         //a panel that holds currRock question
  
  var messageField;   //Message display field
  var scoreField;     //score Field
  var levelField;     //level Field
  var qEnglishField;
  var qTextField;
  var typingField;    //user input
  var debugField;

  var loadingInterval = 0;
  
  var freeze_counter = 0;
  var MAX_FREEZE = 10;
  
  var score = 0;
</script>



<div id="error">
  <h1> Sorry &gt;_&lt; It looks like your browswer is not compatible.</h1>
</div>

<script id="gameplay">

	//register key functions
	document.onkeydown = handleKeyDown;
	document.onkeyup = handleKeyUp;
  var game;


	function init() {
		if (!createjs.Sound.initializeDefaultPlugins()) {
			document.getElementById("error").style.display = "block";
			document.getElementById("content").style.display = "none";
			return;
		}
    
		canvas = document.getElementById("gameCanvas");
		stage = new createjs.Stage(canvas);
		
    instructionTitle = new createjs.Text("CantoRocks", "bold 36px Pixel", "#FFFFCC");
    instructionTitle.textAlign = "left";
    instructionTitle.textBaseline = "top";
    instructionTitle.x = 30;
    instructionTitle.y = 20;
    
		instructionField = new createjs.Text("", "bold 24px Pixel", "#FFFFFF");
    instructionField.textAlign = "left";
    instructionField.textBaseline = "top";
    instructionField.lineWidth = 600;
    instructionField.x = 30;
    instructionField.y = 60;		
    instructionField.text = "Jyutping giant is dropping rocks to the Earth. You need 1000 points to save the planet. There is one weak spot. When they attack, you will hear a word. Type the word in Jyutping and you can destroy the falling rock.";
		
		messageField = new createjs.Text("Loading", "bold 24px Pixel", "#FFCCFF");
		messageField.maxWidth = 600;
		messageField.textAlign = "right";
		messageField.textBaseline = "bottom";
		messageField.x = canvas.width - 10;
		messageField.y = canvas.height -10;
		
    debugField = new createjs.Text("", "bold 20px Arial", "#FF0000");
    debugField.maxWidth = 240;
    debugField.textAlign = "left";
    debugField.textBaseline = "middle";
    debugField.x = 10;
    debugField.y = 100;

    stage.addChild(messageField);
    stage.addChild(instructionTitle);
    stage.addChild(instructionField);
		stage.update();

		// begin loading content
		var assetsPath = "sounds/";
		manifest = [
			{id: "begin", src: "spawn.ogg"},
			{id: "break", src: "break.ogg", data: 6},
			{id: "death", src: "death.ogg"},
			{id: "laser", src: "shot.ogg", data: 6},
			{id: "music", src: "music.ogg"}
		];

    var assetsPath2 = "images/";
    rockimages = [
      {id: "rock1", src: "brownrock.png"},
      {id: "rock2", src: "greyrock.png"}
    ];    

    //createjs.Sound.alternateExtensions = ["mp3"];
    
		preload = new createjs.LoadQueue(true, assetsPath);
		preload.installPlugin(createjs.Sound);
		preload.loadManifest(manifest);
		
    preload2 = new createjs.LoadQueue(true, assetsPath2);
    preload2.loadManifest(rockimages);
    
    preload3 = new createjs.LoadQueue(true, "");
    preload3.installPlugin(createjs.Sound);
    preload3.addEventListener("complete", doneLoading); // add an event listener for when load is completed
    preload3.addEventListener("progress", updateLoading);
    preload3.loadManifest(words);
	}

	function updateLoading() {
		messageField.text = "Loading " + (preload.progress * 100 | 0) + "%";
		stage.update();
	}

	function doneLoading(event) {
		clearInterval(loadingInterval);

		messageField.text = "Press Enter to continue...";
    stage.update();   //update the stage to show text

		// start the music
		//createjs.Sound.play("music", {interrupt: createjs.Sound.INTERRUPT_NONE, loop: -1, volume: 0.05});

		watchRestart();
	}

	function watchRestart() {
		//watch for clicks
		pendingStart = true;
	}

	//reset all game logic
	function restart() {
	  // indicate the player is now on screen
    createjs.Sound.play("begin");
		stage.removeAllChildren();

    var lp = new createjs.Bitmap("images/leftpanel.png");
    lp.x = 0;
    lp.y = 0;
    lp.scaleX = 260 / 64;
    lp.scaleY = 480 / 64;
		
    var bg = new createjs.Bitmap("images/background.png");
    bg.x = 260;
    bg.y = 0;
    bg.scaleX = 0.7;
    bg.scaleY = 1;
  
    stage.addChild(lp);
    stage.addChild(bg);		
		
		gamePanel = new createjs.Container();
		gamePanel.x = 260;
		gamePanel.y = 0;
		gamePanel.width = canvas.width - 260;
		gamePanel.height = canvas.height;
		stage.addChild(gamePanel);   

    levelField = new createjs.Text("Lv 0", "bold 20px Pixel", "#FFFFCC");
    levelField.textAlign = "left";
    levelField.x = 20;
    levelField.y = 20;
    levelField.maxWidth = 260;
    
    scoreField = new createjs.Text("0", "bold 40px Pixel", "#FFFFFF");
    scoreField.textAlign = "right";
    scoreField.x = 220;
    scoreField.y = 100;
    scoreField.maxWidth = 260;    


    qTextField = new createjs.Text("", "bold 40px Pixel", "#483C32");
    qTextField.maxWidth = 260;
    qTextField.textAlign = "center";
    qTextField.textBaseline = "middle";
    qTextField.x = 100;
    qTextField.y = 160;        

    qEnglishField = new createjs.Text("", "bold 15px Pixel", "#832A0D");
    qEnglishField.maxWidth = 200;
    qEnglishField.textAlign = "center";
    qEnglishField.textBaseline = "middle";
    qEnglishField.x = 100;
    qEnglishField.y = 200;        

    qPanel = new createjs.Container();
    qPanel.x = 30;
    qPanel.y = 150;
    qPanel.width = 200;
    qPanel.height = 250;
    
    stage.addChild(qPanel);
    qPanel.addChild(qEnglishField);
    qPanel.addChild(qTextField);

    
    var g = new createjs.Graphics();
    g.setStrokeStyle(3);
    g.beginStroke("#000000");
    g.beginFill("white");
    g.drawRoundRect (40,380,180,30,8);
    typingBox = new createjs.Shape(g);
    stage.addChild(typingBox);

    typingField = new createjs.Text("", "bold 18px Courier", "#000000");
    typingField.maxWidth = 260;
    typingField.textAlign = "left";
    typingField.textBaseline = "middle";
    typingField.x = 60;
    typingField.y = 394;    
    
    stage.addChild(typingField);		
		stage.addChild(scoreField);
    stage.addChild(levelField);		
    stage.addChild(debugField);		
    stage.update();

		//start game timer
		if (!createjs.Ticker.hasEventListener("tick")) {
			createjs.Ticker.addEventListener("tick", tick);
		}
		
		//Game Logic below
		game = new GameState();
    //reset rockBelt
    rockBelt = [];
	}

	function tick(event) {
	  switch(game.getState()){
	    case INIT_STATE:
	      game.changeState(GAME_STATE); 
	    case GAME_STATE: 
        //Scenario 0: Rock removed
        if (freeze_counter > 0) {
          currRock.alpha = freeze_counter / MAX_FREEZE;
          freeze_counter--;
          if (freeze_counter == 0){
            gamePanel.removeChild(currRock);
            game.logAction(currRock.question,currRock.question.text.length);
            scoreField.text = game.getScore().toString();
            levelField.text = "Lv:" + game.getLevel().toString();
            createjs.Sound.play("break", createjs.Sound.INTERRUPT_ANY);
          } else {
            stage.update(event);  // update other sub events
            return;          
          }
        }
        
        //Scenario 1: bottom reached
        if (currRock) {
          if (currRock.y + currRock.getBounds().height > canvas.height) {
            currRock.freeze(preload2.getResult("rock2"));
          }
        }
  
        //Scenario 2: check if it has reached other rocks
        if (currRock) {
          for (spaceRock in rockBelt) {
            var r = rockBelt[spaceRock];
            if (!r.launched) continue;
            if (r == currRock) continue;
            var x_dif = Math.abs(currRock.x - r.x);
            var y_dif = Math.abs(currRock.y - r.y);
            if (Math.sqrt ( (x_dif * 84 / 101) * (x_dif * 84/101) + y_dif * y_dif ) < 84) {
              currRock.freeze(preload2.getResult("rock2")); //freeze the rock
  
              // check whether the user has lost the game
              if (currRock.y < 0) {
                game.changeState(ENDINGGAME_STATE);
                break; 
              }
              break;    
            }
          }
        }  
    
        //Generate new rock if no active rock
        if (!currRock || !currRock.active) {
          typingField.text = "";
          currRock = new Rock();
          currRock.init(preload2.getResult("rock1"), new Question(Math.floor(Math.random()*BANK.length)));
          rockBelt.push(currRock);
          gamePanel.addChild(currRock);
          qEnglishField.text = currRock.question.english;
          qTextField.text = currRock.question.text;
          var inst = createjs.Sound.play(currRock.question.id, createjs.Sound.INTERRUPT_ANY);
        }
        
        if (currRock.active) {
          currRock.tick(event, game);     
        }
        //call sub ticks
        stage.update(event);
	    break;
	    case ENDINGGAME_STATE: 
        //Officially ending the game        
        game.changeState(ENDGAME_STATE);
        //play death sound
        createjs.Sound.play("death", createjs.Sound.INTERRUPT_ANY);

        var g = new createjs.Graphics();
        g.beginFill("rgba(0, 0, 0, 0.8)").drawRect(260,0,canvas.width-260,canvas.height);
        stage.addChild(new createjs.Shape(g));
        
        messageField.text = "You're dead:  Click or hit enter to play again";       
        stage.addChild(messageField);    
        stage.update(event);    
	    break;
	    case ENDGAME_STATE:
        watchRestart();  	     
	    break;
	  }
	  
	}

	//allow for WASD and arrow control scheme
	function handleKeyDown(e) {
		//cross browser issues exist
		if (!e) {
			var e = window.event;
		}
		
		if (pendingStart) {
      switch (x) {
        case 13:
          pendingStart = false;     
          restart();
      }		  
		  return false;
		}
		
		var x = e.keyCode;
		switch (x) {
		  case 8:
		    typingField.text = typingField.text.substr(0,typingField.text.length-1);
		    return false;
			case 13:
			  typingField.text = "";
				return false;
		}
		if (!e.altKey && !e.metaKey){
  		  if (x == 32 || x >= 65 && x <= 90){
  		  typingField.text = typingField.text + String.fromCharCode(x).toLowerCase();
  		  
  		  if (currRock) {
  		    if (currRock.check(typingField.text)) {  		      
  		      var index = rockBelt.indexOf(currRock);
  		      rockBelt.splice(index,1);
  		      currRock.active = false;
            freeze_counter = MAX_FREEZE;
  		    }  
  		  }
  		  return false;
  		}
		}
	}

	function handleKeyUp(e) {
		//cross browser issues exist
		if (!e) {
			var e = window.event;
		}
		switch (e.keyCode) {
		}
		return false;
	}

</script>

</body>
</html>
